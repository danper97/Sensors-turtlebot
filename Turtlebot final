rosshutdown
rosinit ('localhost')
ipaddress = 'localhost';
tbot = turtlebot(ipaddress);


% Create subscribers and publisher
colorImgSub = rossubscriber('/camera/rgb/image_raw', 'BufferSize', 5);
robot = rospublisher('cmd_vel');
velmsg = rosmessage(robot);
laser = rossubscriber('scan');

% Parameters for ball position and size
sizeGoal = 68517;
distanceThreshold = 0.9;

while (1)
    scan = receive(laser,3);
    data = readCartesian(scan);
    x = data(end,1);
    y = data(end,2);
    dist = sqrt(x.^2 + y.^2);
    minDist = min(dist);
    % Get latest image, ball postion, and ball size.
    latestImg = getColorImage(tbot);
    [height,width] = size(latestImg);
    %[position,ballSize] = FindBlueBall(latestImg,blueBallParams);
    figure(1)
    plot(scan);
    params.darkMin = 160;
    params.blueMax = 120;  % Maximum permissible deviation from pure blue
    img = latestImg;
    blueImg = img(:,:,1)/2 + img(:,:,2)/2 - img(:,:,3)/2;
    blueThresh = blueImg < params.blueMax;
    darkIso = -img(:,:,1)/2 - img(:,:,2)/2 + 3*img(:,:,3) - 2*rgb2gray(img);
    darkThresh = darkIso > params.darkMin;
    ball1 = blueThresh & darkThresh;
%     s = regionprops(ball1, {'Centroid','Area'});
    Rmin = 50;
    Rmax = 1200;
    [center, radius] = imfindcircles(ball1,[Rmin Rmax],'ObjectPolarity','bright');
%     position = s.Centroid;
%     ballSize = s.Area;
    position = center;
    ballSize = pi* (radius*radius);


% Initialize velocities to zero.
    linearVel = 0; 
    angularVel = 0;
    
    % Left and right controls
    if isempty(position)
       if minDist < distanceThreshold
          linearVel = -.1;
          angularVel = 1.6;
       else
          linearVel = .12;
          angularVel = 0;
       end 
    elseif (position(1) < (height/2))
        angularVel = 0.1;
    elseif (position(1) > (height/2))
        angularVel = -0.1;
    elseif (position(1) == (height/2))
       angularVel = 0; 
    end
    
    % Forward and back control
    if isempty(ballSize)
       if minDist < distanceThreshold
          linearVel = -.1;
          angularVel = 1.6;
       else
          linearVel = .12;
          angularVel = 0;
        end 
    elseif ballSize > sizeGoal 
        linearVel = - 0.1;
    elseif ballSize < sizeGoal 
        linearVel = 0.1;
    elseif ballSize == sizeGoal 
        linearVel = 0; 
    end
    
    % Send velocity commands and wait for commands to send.
      velmsg.Linear.X = linearVel;
      velmsg.Angular.Z = angularVel;
      send(robot,velmsg);
      imgc = receive(colorImgSub);
      figure(2)
      imshow(readImage(imgc))
      
 end




